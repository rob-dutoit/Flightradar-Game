<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Flight Tracker</title>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #header-airport {
            font-size: 20px;
            font-weight: bold;
            margin-top: 15px;
        }

        #cumulative-count {
            margin: 10px;
            font-weight: bold;
            text-align: center;
        }

        #map {
            height: 600px;
            width: 600px;
            border-radius: 50%;
            overflow: hidden;
        }

        button {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div id="header-airport">
        Fly me:
    </div>

    <!-- Cumulative counter -->
    <div id="cumulative-count">
        Total Clicks: 0
    </div>

    <!-- Map -->
    <div id="map"></div>

    <script>
        const map = L.map('map');

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        let airports = {};
        const defaultAirportCode = "TSV";

        fetch("/static/airports.json")
    .then(res => res.json())
    .then(data => {
        airports = data;

        // Loop through all airports in JSON
        Object.keys(airports).forEach(code => {

            const coords = airports[code];

            // Add airport marker
            L.marker(coords, {
                icon: airportIcon
            })
            .addTo(map)
            .bindPopup(`<b>${code} Airport</b>`);
        });

        // Set default view
        if (airports[defaultAirportCode]) {
            map.setView(airports[defaultAirportCode], 9);
            document.getElementById("header-airport").innerText =
                `Fly me: ${defaultAirportCode}`;
        }
    });

        const planeIcon = L.icon({
            iconUrl: "/static/plane.png",
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });

        const airportIcon = L.icon({
    iconUrl: "/static/airport.png",   // put airport.png in /static/
    iconSize: [25, 25],
    iconAnchor: [12, 12],
    popupAnchor: [0, -10]
});

        let flightButtonClicks = {};
        let totalClicks = 0;
        let flights = [];

        function zoomToAirport(code) {
            const coords = airports[code];

            if (!coords) {
                console.log("Airport not found:", code);
                return;
            }

            map.flyTo(coords, 9);

            // Update header
            document.getElementById("header-airport").innerText =
                `Fly me: ${code}`;
        }

        function trackClick(flightNo, type, airport) {

            flightButtonClicks[flightNo][type]++;
            totalClicks++;

            document.getElementById('cumulative-count').innerText =
                `Total Clicks: ${totalClicks}`;

            zoomToAirport(airport);

            const flight = flights.find(f => f.flight_no === flightNo);
            if (flight && flight.marker) {
                flight.marker.setPopupContent(getPopupHTML(flight));
                flight.marker.openPopup();
            }
        }

        fetch("/static/flights.json")
            .then(res => res.json())
            .then(data => {

                flights = data;

                flights.forEach(flight => {

                    flightButtonClicks[flight.flight_no] = {
                        departure: 0,
                        arrival: 0
                    };

                    const marker = L.marker([flight.lat, flight.long], {
                        icon: planeIcon,
                        rotationAngle: flight.track
                    }).addTo(map);

                    flight.marker = marker;

                    marker.bindPopup(getPopupHTML(flight));
                });
            });

        function getPopupHTML(f) {
            return `
            <div style="text-align: center;">
                <b>${f.flight_no}</b><br>
                <div style="display: flex; justify-content: center; gap: 5px; align-items: center;">
                    <button onclick="trackClick('${f.flight_no}', 'departure', '${f.departure}')">
                        ${f.departure}
                    </button>
                    →
                    <button onclick="trackClick('${f.flight_no}', 'arrival', '${f.arrival}')">
                        ${f.arrival}
                    </button>
                </div>
                <div style="margin-top: 5px;">
                    Track: ${f.track}°<br>
                    Departure clicked: ${flightButtonClicks[f.flight_no].departure}<br>
                    Arrival clicked: ${flightButtonClicks[f.flight_no].arrival}
                </div>
            </div>
            `;
        }

    </script>

</body>

</html>